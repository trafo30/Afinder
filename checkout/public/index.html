<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AFinder · Checkout</title>

  <!-- Culqi Checkout (tokeniza y detecta marca sin exponer tu backend a datos de tarjeta) -->
  <script src="https://checkout.culqi.com/js/v4"></script>
  <script>
    const CULQI_PUBLIC_KEY = "pk_test_TU_CLAVE_PUBLICABLE";
  </script>

  <style>
    :root{
      --pri:#d81e28; --pri-dark:#a5121a; --bg:#f7f8fb; --line:#eef1f6; --txt:#0d1117;
      --muted:#6b7280; --radius:16px; --shadow:0 18px 50px rgba(0,0,0,.10);
    }
    *{box-sizing:border-box} body,html{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);backdrop-filter:saturate(140%) blur(10px);z-index:10}
    .nav{max-width:1180px;margin:0 auto;padding:14px 24px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#ff6a6a,var(--pri));display:grid;place-items:center;box-shadow:var(--shadow)}
    .logo svg{width:20px;height:20px;color:#fff}
    .brand h1{margin:0;font-size:18px}
    .grid{max-width:1180px;margin:24px auto;display:grid;gap:24px;grid-template-columns:1.6fr 1fr}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}

    .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card-header{padding:16px 18px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .card-header h2{margin:0;font-size:18px}
    .card-body{padding:18px}

    /* Estilo LATAM-like para formulario */
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .full{grid-column:1 / -1}
    label{font-size:13px;color:#374151;margin-bottom:6px;display:block}
    .field{display:flex;flex-direction:column}
    input,select{padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff;box-shadow:0 8px 18px rgba(13,17,23,.03)}
    .muted{color:var(--muted);font-size:13px}
    .btn{appearance:none;border:0;background:linear-gradient(135deg,#ff6a6a,var(--pri));color:#fff;padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:0 12px 28px rgba(216,30,40,.25)}
    .summary-row{display:flex;justify-content:space-between;margin:8px 0}
    .total{font-weight:900}

    .toast{position:fixed;right:20px;bottom:20px;background:#111;color:#fff;padding:10px 12px;border-radius:10px;opacity:0;transform:translateY(10px);transition:.2s}
    .toast.show{opacity:1;transform:none}
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand">
        <div class="logo">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 14s3-4 9-4 9 4 9 4"></path><path d="M10 18h4"></path><circle cx="7.5" cy="14.5" r="1.5"></circle><circle cx="16.5" cy="14.5" r="1.5"></circle></svg>
        </div>
        <h1>AFinder · Checkout</h1>
      </div>
    </div>
  </header>

  <main class="grid">
    <!-- Columna izquierda: formulario tipo LATAM adaptado a autos/repuestos -->
    <section class="card">
      <div class="card-header"><h2>Datos del cliente</h2></div>
      <div class="card-body">
        <form id="af-form" class="form-grid">
          <div class="field">
            <label>Nombre</label>
            <input id="firstName" placeholder="Nombre" required>
          </div>
          <div class="field">
            <label>Apellido</label>
            <input id="lastName" placeholder="Apellido" required>
          </div>

          <div class="field">
            <label>Fecha de nacimiento</label>
            <input id="dob" type="text" placeholder="dd-mm-aaaa">
          </div>
          <div class="field">
            <label>Género</label>
            <select id="gender">
              <option>Masculino</option>
              <option>Femenino</option>
              <option>Otro</option>
            </select>
          </div>

          <div class="field">
            <label>Nacionalidad</label>
            <select id="country">
              <option value="PE">Perú</option>
              <option value="CL">Chile</option>
              <option value="CO">Colombia</option>
              <option value="MX">México</option>
            </select>
          </div>
          <div class="field">
            <label>Tipo de documento</label>
            <select id="doctype">
              <option value="dni">DNI</option>
              <option value="ce">Carné de extranjería</option>
              <option value="pas">Pasaporte</option>
            </select>
          </div>

          <div class="field">
            <label>Número de documento</label>
            <input id="doc" placeholder="Sin puntos ni guión">
          </div>
          <div class="field">
            <label>Tipo de compra</label>
            <select id="segment">
              <option>Vehículo</option>
              <option>Repuesto</option>
              <option>Accesorio</option>
              <option>Servicio</option>
            </select>
          </div>

          <div class="field full">
            <label>Email (para comprobante)</label>
            <input id="email" type="email" placeholder="correo@ejemplo.com" required>
          </div>

          <div class="field full">
            <p class="muted">El cobro de prueba será de <b>S/ 5.00</b> (o el monto configurado) y se devolverá automáticamente.</p>
          </div>

          <div class="field full">
            <button class="btn" type="submit">Continuar y pagar (Culqi)</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Columna derecha: resumen -->
    <aside class="card">
      <div class="card-header"><h2>Resumen</h2></div>
      <div class="card-body">
        <div class="summary-row"><span>Producto</span><span>AutoFinder (demo)</span></div>
        <div class="summary-row"><span>Subtotal</span><span>S/ 0.00</span></div>
        <div class="summary-row"><span>Envío</span><span>S/ 0.00</span></div>
        <div class="summary-row"><span>Comisión plataforma</span><span>5%</span></div>
        <div class="summary-row total"><span>Total estimado</span><span>S/ 5.00</span></div>
      </div>
    </aside>
  </main>

  <div class="toast" id="toast"></div>

  <script>
    // Toast helper
    function toast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show');
      clearTimeout(window.__tt); window.__tt = setTimeout(()=>t.classList.remove('show'), 1800);
    }

    // Configura Culqi Checkout
    Culqi.publicKey = CULQI_PUBLIC_KEY;
    Culqi.settings({
      title: 'AFinder',
      currency: 'PEN',
      description: 'Demo cobro y reembolso',
      amount: 500   // S/5.00 en céntimos
    });

    // Al cerrar/aceptar Culqi (Culqi v4 usa window.culqi)
    window.culqi = async function() {
      if (Culqi.token) {
        const tokenId = Culqi.token.id;
        const email = document.getElementById('email').value.trim();
        try {
          const resp = await fetch('/pay', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ tokenId, email })
          });
          const data = await resp.json();
          if (!resp.ok) { throw new Error(data.error || 'Error en pago'); }
          toast('Cobro y reembolso realizados');
        } catch (e) {
          toast(e.message);
        }
      } else {
        // Si Culqi devuelve un error de token
        toast(Culqi.error?.user_message || 'Error con la tarjeta');
      }
    };

    // Submit del formulario → abrir Culqi Checkout
    document.getElementById('af-form').addEventListener('submit', (e)=>{
      e.preventDefault();
      // Ideal: validar campos como en tu otra pantalla
      Culqi.open();
    });
  </script>
</body>
</html>
